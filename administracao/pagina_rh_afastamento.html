<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataTables com API</title>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.min.css">
</head>
<body>
    <table id="example" class="display" style="width:100%">
        <thead>
            <tr>
                <th>ID</th>
                <th>Funcionário</th>
                <th>Função</th>
                <th>CPF</th>
                <th>Cargo</th>
                <th>Data Início</th>
                <th>Data Fim</th>
                <th>Afastamento</th>
                <th>Observações</th>
                <th>Criado em</th>
            </tr>
        </thead>
    </table>

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>
    <!-- Axios JS -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const table = $('#example').DataTable({
                "pageLength": 15,
                "order": [[0, "desc"]]
            });

            axios.get('https://siupa.com.br/siiupa/api/rh/api.php/records/tb_afastamento?order=id,desc&join=tb_funcionario')
                .then(response => {
                    const records = response.data.records;
                    records.forEach(record => {
                        axios.get(`https://siupa.com.br/siiupa/api/rh/api.php/records/tb_cargo/${record.fk_funcionario.fk_cargo}`)
                            .then(cargoResponse => {
                                const cargo = cargoResponse.data.records[0].nome;

                                axios.get(`https://siupa.com.br/siiupa/api/rh/api.php/records/tb_afastamentos/${record.fk_afastamentos}`)
                                    .then(afastamentoResponse => {
                                        const afastamento = afastamentoResponse.data.records[0].afastamento;

                                        table.row.add([
                                            record.id,
                                            record.fk_funcionario.nome,
                                            record.fk_funcionario.funcao_upa,
                                            record.fk_funcionario.cpf,
                                            cargo,
                                            record.data_inicio,
                                            record.data_fim,
                                            afastamento,
                                            record.afastamento_obs,
                                            record.created_at
                                        ]).draw();
                                    })
                                    .catch(error => console.error('Erro ao buscar afastamento:', error));
                            })
                            .catch(error => console.error('Erro ao buscar cargo:', error));
                    });
                })
                .catch(error => console.error('Erro ao buscar dados:', error));
        });
    </script>
</body>
</html>
